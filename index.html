<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Flappy Night</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #0b132b;
    touch-action: manipulation;
  }
  canvas {
    display: block;
  }
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

// Bird
let bird = { x: canvas.width * 0.25, y: canvas.height / 2, r: 14, v: 0 };
const gravity = 0.5;
const jump = -9;

// Game
let pipes = [];
let stars = [];
let frame = 0;
let score = 0;
let gameOver = false;

// Create stars
for (let i = 0; i < 80; i++) {
  stars.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    r: Math.random() * 1.5 + 0.5
  });
}

// Reset
function resetGame() {
  bird.y = canvas.height / 2;
  bird.v = 0;
  pipes = [];
  score = 0;
  frame = 0;
  gameOver = false;
}

// Input
function flap() {
  if (gameOver) resetGame();
  bird.v = jump;
}
document.addEventListener("touchstart", flap);
document.addEventListener("click", flap);

// Background night
function drawBackground() {
  let g = ctx.createLinearGradient(0,0,0,canvas.height);
  g.addColorStop(0, "#0b132b");
  g.addColorStop(1, "#1c2541");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

// Stars
function drawStars() {
  ctx.fillStyle = "white";
  stars.forEach(s => {
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    ctx.fill();
    s.x -= 0.2;
    if (s.x < 0) s.x = canvas.width;
  });
}

// Bird
function drawBird() {
  ctx.fillStyle = "#FFD600";
  ctx.beginPath();
  ctx.arc(bird.x, bird.y, bird.r, 0, Math.PI * 2);
  ctx.fill();
}

// Pipes
function updatePipes() {
  if (frame % 90 === 0) {
    let gap = 160;
    let top = Math.random() * (canvas.height - gap - 200) + 100;
    pipes.push({
      x: canvas.width,
      w: 60,
      top: top,
      gap: gap,
      passed: false
    });
  }

  pipes.forEach(p => {
    p.x -= 3;

    if (
      bird.x + bird.r > p.x &&
      bird.x - bird.r < p.x + p.w &&
      (bird.y - bird.r < p.top ||
       bird.y + bird.r > p.top + p.gap)
    ) gameOver = true;

    if (!p.passed && p.x + p.w < bird.x) {
      score++;
      p.passed = true;
    }
  });

  pipes = pipes.filter(p => p.x + p.w > 0);
}

function drawPipes() {
  ctx.fillStyle = "#2e7d32";
  pipes.forEach(p => {
    ctx.fillRect(p.x, 0, p.w, p.top);
    ctx.fillRect(p.x, p.top + p.gap, p.w, canvas.height);
  });
}

// Score
function drawScore() {
  ctx.fillStyle = "#fff";
  ctx.font = "bold 42px Arial";
  ctx.textAlign = "center";
  ctx.fillText(score, canvas.width / 2, 80);
}

// Game Over
function drawGameOver() {
  ctx.fillStyle = "#fff";
  ctx.font = "bold 36px Arial";
  ctx.textAlign = "center";
  ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2 - 20);
  ctx.font = "18px Arial";
  ctx.fillText("Chạm màn hình để chơi lại", canvas.width / 2, canvas.height / 2 + 20);
}

// Loop
function loop() {
  drawBackground();
  drawStars();

  if (!gameOver) {
    bird.v += gravity;
    bird.y += bird.v;
    updatePipes();
  }

  drawPipes();
  drawBird();
  drawScore();

  if (bird.y < 0 || bird.y > canvas.height) gameOver = true;
  if (gameOver) drawGameOver();

  frame++;
  requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>
